@page "/lessonbooking"
@using GymManagementSystem.Backend
@using GymManagementSystem.Backend.Entities
@using System.Text.Json
@using System.IO

<div class="page">
	<h1>Book Lesson</h1>
	<div class="section">
		<div class="input">
			<label>Lesson</label>
			<select style="width:100%" @bind="lessonCode">
				<option value="0">Select a Lesson</option>
				@foreach (Lesson lesson in lessonManager.Lessons)
				{
					<option value="@lesson.Code">@lesson.Name</option>
				}
			</select>
			<div>
				@foreach (Lesson lesson in lessonManager.Lessons)
				{
					if (lesson.Code == lessonCode)
					{
						<h2>Lesson Description: @lesson.Description </h2>
					}
				}
			</div>
		</div>
		<div>
			<button class="findSchedule" @onclick="FindSchedules">Find Schedule</button>
		</div>
	</div>
</div>
<div class="tableSection">
<h1>Result</h1>


<table class="displayTable">
	<thead>
		<tr>
			<th>Select</th>
			<th>Start Time</th>
			<th>Duration</th>
			<th>Location</th>
			<th>Max Capacity</th>
			<th>Capacity Left</th>
		</tr>
	</thead>
	<tbody>
			@if (scheduleSearch.Count > 0)
			{
				@foreach (Schedule schedule in scheduleSearch)
				{
						<tr>
							<td>
								<input type="radio" name="selectedSchedule" @onclick="()=>SelectSchedule(schedule)"/>
							</td>
							<td>@schedule.Time</td>
							<td>@schedule.Duration</td>
							<td>@schedule.Location</td>
							<td>@schedule.Capacity</td>
							<td>@bookingManager.AvailableCapacity(schedule)</td>
						</tr>
				}
			}
			else
			{
				<tr>
					<td></td>
					<td>No schedule found</td>
				</tr>
			}

	</tbody>
</table>

<div class="bookingSection">
	<h1>Booking</h1>
		<div class="bookingInfo">
			<label>Lesson Code:</label>
			<input type="text" @bind="selectedScheduleCode" readonly="readonly" />
		</div>
		<div class="bookingInfo">
			<label>Location:</label>
			<input type="text" @bind="selectedLocation" readonly="readonly" />
		</div>
		<div class="bookingInfo">
			<label>Start Time:</label>
			<input type="text" @bind="selectedTime" readonly="readonly" />
		</div>
		<div class="bookingInfo">
			<label>End Time:</label>
			<input type="text" @bind="selectedEndTime" readonly="readonly" />
		</div>
		<div class="bookingInfo">
			<label>Lesson Duration:</label>
			<input type="text" @bind="selectedDuration" readonly="readonly" />
		</div>
		<div class="bookingInfo">
			<label>Member Name:</label>
			<input type="text" @bind="memberName" />
		</div>
		<div class="bookingInfo">
			<label>Member ID:</label>
			<input type="text" @bind="memberID" />
		</div>
</div>
	<div style="text-align: center;">
		<button class="reserveButton" @onclick="ConfirmBooking">Confirm</button>
	</div>
	<p style="text-align: center"> @message</p>
</div>
@code {
	private int lessonCode;
	private List<Schedule> scheduleSearch = new();
	private LessonManager lessonManager = new LessonManager();
	private ScheduleManager scheduleManager = new ScheduleManager();
	private BookingManager bookingManager = new BookingManager();
	private int selectedScheduleCode;
	private Schedule selectedSchedule;
	private string selectedTime;
	private string selectedLocation;
	private int selectedDuration;
	private string selectedEndTime;
	private string memberName;
	private string memberID;
	private string message;

	public void FindSchedules()
	{
		scheduleSearch.Clear();
		foreach (Schedule schedule in scheduleManager.Schedules)
		{
			if (schedule.Code == lessonCode)
			{

				scheduleSearch.Add(schedule);
			}
		}
	}

	private void SelectSchedule(Schedule schedule)
	{
		selectedSchedule = schedule;
		selectedScheduleCode = schedule.Code;
		selectedLocation = schedule.Location;
		selectedDuration = schedule.Duration;
		selectedTime = schedule.Time;
		selectedEndTime = schedule.EndTime();
	}

	public void ConfirmBooking()
	{
		if (bookingManager.AvailableCapacity(selectedSchedule) > 0)
		{
			if (!string.IsNullOrEmpty(memberName) && !string.IsNullOrEmpty(memberID))
			{
				//write condition to validate name and id
				Booking newBooking = bookingManager.BookLesson(selectedSchedule, memberName, memberID);
				message = "Successfully Booked!";
			}
			else
			{
				message = "Please Enter Name and ID";
			}
		}
		else
		{
			message = "Lesson is full";
		}

	}
}
